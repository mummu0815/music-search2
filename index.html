<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #F3E8FF; /* 기본 배경색 변수 */
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color); /* CSS 변수를 사용하도록 변경 */
            transition: background-color 0.3s ease; /* 부드러운 전환 효과 추가 */
        }
        .card {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        #searchResults::-webkit-scrollbar { width: 8px; }
        #searchResults::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #searchResults::-webkit-scrollbar-thumb { background: #C4B5FD; border-radius: 10px; }
        #searchResults::-webkit-scrollbar-thumb:hover { background: #A78BFA; }
        
        /* Layout Styles */
        .player.layout-horizontal { flex-direction: row; align-items: center; width: 100%; }
        .player.layout-horizontal .album-art { width: 5rem; height: 5rem; }
        .player.layout-horizontal .info-section { 
            margin-left: 1rem; 
            text-align: left; 
            min-width: 0; /* 이 요소가 Flex 아이템으로서 줄어들도록 허용 */
            overflow: hidden;
        }
        .player.layout-horizontal .info-section .flex { justify-content: flex-start; }
        .player.layout-horizontal .controls-section { flex-direction: row; align-items: center; }

        .player.layout-vertical { flex-direction: column; align-items: center; width: 288px; }
        .player.layout-vertical .album-art { width: 10rem; height: 10rem; }
        .player.layout-vertical .info-section { margin-left: 0; margin-top: 1rem; text-align: center; width: 100%; padding: 0 1rem; }
        .player.layout-vertical .info-section .flex { justify-content: center; }
        .player.layout-vertical .controls-section { flex-direction: column; margin-top: 1rem; gap: 0.5rem; }
        .player.layout-vertical .controls-section canvas { margin-left: 0; }

        /* Settings Panel Styles */
        #settingsPanel { opacity: 0; transform: scale(0.95) translateY(10px); transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; pointer-events: none; }
        #settingsPanel.open { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }

        /* Custom range slider style */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { height: 8px; cursor: pointer; background: #E5E7EB; border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -4px; height: 16px; width: 16px; border-radius: 50%; background: #A855F7; cursor: pointer; }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="w-full max-w-3xl mx-auto p-4">
        
        <div class="mb-8 flex justify-center">
            <div id="player" class="player flex p-4 rounded-2xl shadow-lg text-white transition-all duration-500 ease-in-out transform layout-horizontal">
                <img id="albumArt" src="https://placehold.co/80x80/6d28d9/ffffff?text=Album" alt="Album Art" class="album-art rounded-lg shadow-md flex-shrink-0 transition-all">
                <div class="flex-grow min-w-0 info-section">
                    <h2 id="trackTitle" class="font-bold text-lg min-w-0 truncate">노래 제목</h2>
                    <p id="trackArtist" class="text-white text-sm mt-1 min-w-0 truncate">아티스트 이름</p>
                    <div class="flex items-center text-sm opacity-80 mt-2">
                        <span class="mr-2">SING 🎤</span>
                        <p id="artistName">채널명</p>
                    </div>
                </div>
                <div class="controls-section flex items-center">
                    <div class="flex items-center space-x-2 text-2xl">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a1 1 0 00-1 1v10a1 1 0 001 1h1a1 1 0 001-1V5a1 1 0 00-1-1H4z"></path><path d="M15.25 14.5a1 1 0 01-1.5.866l-6-4.5a1 1 0 010-1.732l6-4.5a1 1 0 011.5.866v8.5z"></path></svg>
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M15 4a1 1 0 00-1 1v10a1 1 0 001 1h1a1 1 0 001-1V5a1 1 0 00-1-1h-1z"></path><path d="M4.75 14.5a1 1 0 001.5.866l6-4.5a1 1 0 000-1.732l-6-4.5a1 1 0 00-1.5.866v8.5z"></path></svg>
                    </div>
                    <canvas id="waveformCanvas" width="120" height="40" class="ml-4"></canvas>
                </div>
            </div>
        </div>

        <header class="text-center mb-6">
            <h1 id="mainTitle" class="text-2xl font-bold text-purple-800">Music search</h1>
        </header>
        
        <main>
            <div class="flex items-center space-x-2 mb-6 card p-4">
                <input type="text" id="searchInput" placeholder="아티스트나 곡명을 검색하세요..." class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
                <button id="searchButton" class="bg-purple-600 text-white px-5 py-2 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-transform transform active:scale-95">
                    검색
                </button>
            </div>
            <div id="status" class="text-center text-gray-500 mb-4 h-6"></div>
            <div id="searchResults" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </main>
    </div>

    <div class="fixed bottom-6 right-6 z-50">
        <button id="settingsIconBtn" class="bg-purple-600 text-white rounded-full p-3 shadow-lg hover:bg-purple-700 transition transform hover:scale-110 focus:outline-none">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>

        <div id="settingsPanel" class="card absolute bottom-20 right-0 w-80 bg-white p-6 rounded-2xl shadow-2xl origin-bottom-right space-y-6">
            <div>
                <label for="displayNameInput" class="block text-sm font-medium text-gray-700">표시 채널명</label>
                <div class="mt-1 flex space-x-2">
                    <input type="text" id="displayNameInput" placeholder="채널명을 입력하세요" class="w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    <button id="applyDisplayName" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600">적용</button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">커버 이미지 업로드</label>
                <div class="mt-2 flex space-x-2">
                     <label class="cursor-pointer px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600">
                         <span>이미지 업로드</span>
                         <input type="file" id="imageUpload" class="hidden" accept="image/*">
                     </label>
                     <button id="revertCover" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">원래 썸네일</button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">카드 색상</label>
                <div class="mt-2 flex items-center space-x-1">
                    <div class="flex flex-col items-center"><span class="text-xs text-gray-500 mb-1">기본</span><input type="color" id="primaryColor" class="w-10 h-10 p-1 border-0 rounded-md cursor-pointer"></div>
                    <div class="flex flex-col items-center"><span class="text-xs text-gray-500 mb-1">보조</span><input type="color" id="secondaryColor" class="w-10 h-10 p-1 border-0 rounded-md cursor-pointer"></div>
                    <button id="applyColors" class="self-end px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600">적용</button>
                    <button id="resetColors" class="self-end px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">기본</button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">배경 색상</label>
                <div class="mt-2 flex items-center space-x-1">
                    <input type="color" id="bgColorPicker" class="w-10 h-10 p-1 border-0 rounded-md cursor-pointer">
                    <button id="applyBgColor" class="self-end px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600">적용</button>
                    <button id="resetBgColor" class="self-end px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">기본</button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">카드 레이아웃</label>
                <div class="mt-2 flex space-x-2">
                    <button id="layoutHorizontalBtn" class="px-4 py-2 rounded-md transition-colors flex-1">가로형</button>
                    <button id="layoutVerticalBtn" class="px-4 py-2 rounded-md transition-colors flex-1">세로형</button>
                </div>
            </div>
            <div>
                <label for="waveformSpeed" class="block text-sm font-medium text-gray-700">파형 속도</label>
                <div class="mt-1 flex items-center space-x-2">
                    <span class="text-xs text-gray-500">느리게</span>
                    <input type="range" id="waveformSpeed" min="1" max="15" class="w-full">
                    <span class="text-xs text-gray-500">빠르게</span>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const clientId = '3bdf3377e2c24913a0fbf5a9d1fdb3d0';
            const clientSecret = '9f21f9d8bef14948b07f02e5e826691c';

            // --- DOM Element Selection ---
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResultsContainer = document.getElementById('searchResults');
            const statusDiv = document.getElementById('status');
            const playerDiv = document.getElementById('player');
            const albumArtImg = document.getElementById('albumArt');
            const trackTitleSpan = document.getElementById('trackTitle');
            const trackArtistSpan = document.getElementById('trackArtist');
            const artistNameP = document.getElementById('artistName');
            const waveformCanvas = document.getElementById('waveformCanvas');

            // Settings Elements
            const settingsIconBtn = document.getElementById('settingsIconBtn');
            const settingsPanel = document.getElementById('settingsPanel');
            const displayNameInput = document.getElementById('displayNameInput');
            const applyDisplayName = document.getElementById('applyDisplayName');
            const imageUpload = document.getElementById('imageUpload');
            const revertCover = document.getElementById('revertCover');
            const primaryColor = document.getElementById('primaryColor');
            const secondaryColor = document.getElementById('secondaryColor');
            const applyColors = document.getElementById('applyColors');
            const resetColors = document.getElementById('resetColors');
            const layoutHorizontalBtn = document.getElementById('layoutHorizontalBtn');
            const layoutVerticalBtn = document.getElementById('layoutVerticalBtn');
            const bgColorPicker = document.getElementById('bgColorPicker');
            const applyBgColor = document.getElementById('applyBgColor');
            const resetBgColor = document.getElementById('resetBgColor');
            const waveformSpeed = document.getElementById('waveformSpeed');

            // --- State Variables ---
            let accessToken = null;
            let originalAlbumArtUrl = '';
            let isCustomCoverActive = false;
            let waveformEasingFactor = 0.08;

            // --- Helper Functions for Settings ---
            const saveSetting = (key, value) => localStorage.setItem(key, value);
            const loadSetting = (key, defaultValue) => localStorage.getItem(key) || defaultValue;

            // --- UI Update Functions ---
            const updatePlayerGradient = () => {
                const color1 = primaryColor.value;
                const color2 = secondaryColor.value;
                const direction = playerDiv.classList.contains('layout-vertical') ? '180deg' : '90deg';
                playerDiv.style.background = `linear-gradient(${direction}, ${color1}, ${color2})`;
            };

            const updateLayoutButtons = (layout) => {
                const isHorizontal = layout === 'horizontal';
                layoutHorizontalBtn.classList.toggle('bg-purple-500', isHorizontal);
                layoutHorizontalBtn.classList.toggle('text-white', isHorizontal);
                layoutHorizontalBtn.classList.toggle('bg-gray-200', !isHorizontal);
                layoutHorizontalBtn.classList.toggle('text-gray-700', !isHorizontal);
                
                layoutVerticalBtn.classList.toggle('bg-purple-500', !isHorizontal);
                layoutVerticalBtn.classList.toggle('text-white', !isHorizontal);
                layoutVerticalBtn.classList.toggle('bg-gray-200', isHorizontal);
                layoutVerticalBtn.classList.toggle('text-gray-700', isHorizontal);
            };

            const applyLayout = (layout) => {
                playerDiv.classList.toggle('layout-horizontal', layout === 'horizontal');
                playerDiv.classList.toggle('layout-vertical', layout === 'vertical');
                updateLayoutButtons(layout);
                updatePlayerGradient();
            };

            // --- Waveform Animation ---
            const canvasCtx = waveformCanvas.getContext('2d');
            const barCount = 12, barWidth = 4, spacing = 9;
            let barHeights = new Array(barCount).fill(barWidth);
            let targetHeights = new Array(barCount).fill(barWidth);
            let frameCounter = 0;

            function drawDecorativeWaveform() {
                frameCounter++;
                const { width, height } = waveformCanvas;

                if (frameCounter % 20 === 0) {
                    targetHeights = targetHeights.map(() => Math.max(barWidth, Math.random() * height * 0.9));
                }

                canvasCtx.clearRect(0, 0, width, height);
                canvasCtx.strokeStyle = 'rgba(255, 255, 255, 0.85)';
                canvasCtx.lineWidth = barWidth;
                canvasCtx.lineCap = 'round';

                for (let i = 0; i < barCount; i++) {
                    barHeights[i] += (targetHeights[i] - barHeights[i]) * waveformEasingFactor;

                    const barHeight = barHeights[i];
                    const x = i * spacing + (spacing / 2);
                    const y1 = height / 2 - barHeight / 2;
                    const y2 = height / 2 + barHeight / 2;
                    
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(x, y1);
                    canvasCtx.lineTo(x, y2);
                    canvasCtx.stroke();
                }
                requestAnimationFrame(drawDecorativeWaveform);
            }
            
            // --- Settings Event Listeners ---
            settingsIconBtn.addEventListener('click', () => settingsPanel.classList.toggle('open'));

            applyDisplayName.addEventListener('click', () => {
                const newName = displayNameInput.value.trim();
                artistNameP.textContent = newName || '채널명';
                saveSetting('displayName', newName);
            });

            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        albumArtImg.src = e.target.result;
                        isCustomCoverActive = true;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            revertCover.addEventListener('click', () => {
                if (originalAlbumArtUrl) albumArtImg.src = originalAlbumArtUrl;
                isCustomCoverActive = false;
            });
            
            applyColors.addEventListener('click', () => {
                updatePlayerGradient();
                saveSetting('primaryColor', primaryColor.value);
                saveSetting('secondaryColor', secondaryColor.value);
            });

            resetColors.addEventListener('click', () => {
                primaryColor.value = '#A855F7';
                secondaryColor.value = '#7C3AED';
                updatePlayerGradient();
                localStorage.removeItem('primaryColor');
                localStorage.removeItem('secondaryColor');
            });
            
            applyBgColor.addEventListener('click', () => {
                document.documentElement.style.setProperty('--bg-color', bgColorPicker.value);
                saveSetting('backgroundColor', bgColorPicker.value);
            });

            resetBgColor.addEventListener('click', () => {
                bgColorPicker.value = '#F3E8FF';
                document.documentElement.style.removeProperty('--bg-color');
                localStorage.removeItem('backgroundColor');
            });

            waveformSpeed.addEventListener('input', () => {
                waveformEasingFactor = parseInt(waveformSpeed.value) / 100;
                saveSetting('waveformSpeed', waveformSpeed.value);
            });

            layoutHorizontalBtn.addEventListener('click', () => { applyLayout('horizontal'); saveSetting('layout', 'horizontal'); });
            layoutVerticalBtn.addEventListener('click', () => { applyLayout('vertical'); saveSetting('layout', 'vertical'); });

            // --- Load All Settings on Startup ---
            function loadAllSettings() {
                // Display Name
                const savedName = loadSetting('displayName', '채널명');
                artistNameP.textContent = savedName;
                displayNameInput.value = savedName;
                
                // Card Colors
                primaryColor.value = loadSetting('primaryColor', '#A855F7');
                secondaryColor.value = loadSetting('secondaryColor', '#7C3AED');
                updatePlayerGradient();

                // Background Color
                const savedBgColor = loadSetting('backgroundColor');
                if (savedBgColor) {
                    bgColorPicker.value = savedBgColor;
                    document.documentElement.style.setProperty('--bg-color', savedBgColor);
                } else {
                    bgColorPicker.value = '#F3E8FF';
                }

                // Layout
                const savedLayout = loadSetting('layout', 'horizontal');
                applyLayout(savedLayout);

                // Waveform Speed
                const savedSpeed = loadSetting('waveformSpeed', '8');
                waveformSpeed.value = savedSpeed;
                waveformEasingFactor = parseInt(savedSpeed) / 100;
            }

            // --- Spotify API & Search Logic (No changes in this part) ---
            const getAccessToken = async () => {
                if (clientId === 'YOUR_SPOTIFY_CLIENT_ID' || clientSecret === 'YOUR_SPOTIFY_CLIENT_SECRET') {
                    console.error("Spotify Client ID/Secret is not set. Please update the script.");
                    statusDiv.textContent = "Spotify API 키를 설정해주세요."; return null;
                }
                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret) },
                        body: 'grant_type=client_credentials'
                    });
                    if (!response.ok) throw new Error(`Spotify token error: ${response.statusText}`);
                    const data = await response.json();
                    return data.access_token;
                } catch (error) {
                    console.error('Error getting access token:', error);
                    statusDiv.textContent = "API 토큰 인증에 실패했습니다."; return null;
                }
            };
            const searchTracks = async (query) => { 
                if (!accessToken) {
                    statusDiv.textContent = "인증 중...";
                    accessToken = await getAccessToken();
                    if(!accessToken) return;
                }
                statusDiv.textContent = "검색 중...";
                searchResultsContainer.innerHTML = '';
                try {
                    const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=20`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (!response.ok) {
                        if(response.status === 401) {
                            accessToken = await getAccessToken();
                            if(accessToken) searchTracks(query);
                        } else {
                            throw new Error(`Spotify API error: ${response.statusText}`);
                        }
                        return;
                    }
                    const data = await response.json();
                    displayResults(data.tracks.items);
                } catch (error) {
                    console.error('Error searching tracks:', error);
                    statusDiv.textContent = "검색 중 오류가 발생했습니다.";
                }
            };
            
            const displayResults = (tracks) => {
                searchResultsContainer.innerHTML = '';
                if (tracks.length === 0) {
                    statusDiv.textContent = '검색 결과가 없습니다.'; return;
                }
                statusDiv.textContent = '';
                tracks.forEach(track => {
                    const trackCard = document.createElement('div');
                    trackCard.className = 'bg-white rounded-xl p-3 cursor-pointer hover:shadow-lg transition-shadow group';
                    const albumImage = track.album.images[1]?.url || 'https://placehold.co/300x300/e9d5ff/a855f7?text=?';
                    const artistNames = track.artists.map(artist => artist.name).join(', ');
                    trackCard.innerHTML = `
                        <div class="relative"><img src="${albumImage}" alt="${track.album.name}" class="w-full rounded-lg shadow-sm aspect-square object-cover"></div>
                        <div class="mt-2 text-center">
                            <p class="font-bold text-gray-900 truncate text-sm">${track.name}</p>
                            <p class="text-xs text-gray-600 truncate">${artistNames}</p>
                        </div>
                    `;
                    trackCard.addEventListener('click', () => updatePlayerUI(track));
                    searchResultsContainer.appendChild(trackCard);
                });
            };

            const updatePlayerUI = (track) => {
                const imageUrl = track.album.images[1]?.url || 'https://placehold.co/80x80/6d28d9/ffffff?text=Album';
                const artistNames = track.artists.map(artist => artist.name).join(', ');
                originalAlbumArtUrl = imageUrl;
                imageUpload.value = null;
                if (!isCustomCoverActive) {
                    albumArtImg.src = imageUrl;
                }
                trackTitleSpan.textContent = track.name;
                trackArtistSpan.textContent = artistNames;
            };

            // --- Initial Setup & Search Listeners ---
            const performSearch = () => {
                const query = searchInput.value.trim();
                if (query) searchTracks(query);
            };
            
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') performSearch();
            });

            // --- Run on Load ---
            loadAllSettings();
            drawDecorativeWaveform();
        });
    </script>
</body>
</html>
